#!/bin/bash
# script which create installation image with flow
# requirements are:
#  - docker image flow123d/flow-libs-dev-dbg
#  - docker image flow123d/install

set -x

FLOW=/opt/flow123d/flow123d
PACKAGE_NAME=Flow123d-2.0.0-Linux.tar.gz
PACKAGE_PATH=./$PACKAGE_NAME

IMAGE_NAME=flow123d-image.tar.gz
IMAGE_PATH=./libs/$IMAGE_NAME

# mount
V="-v $(pwd)/build:/opt/flow123d/"


# run container
docker run -tid --name flow_build $V flow123d/flow-libs-dev-dbg
# clone, build and pack flow123d
docker exec flow_build git clone \
            https://github.com/jbrezmorf/flow123d.git $FLOW
docker exec flow_build cp \
            $FLOW/config/config-jenkins-docker-debug.cmake \
            $FLOW/config.cmake
docker exec flow_build make -C $FLOW -j4 package

# copy OUT of container
docker cp   flow_build:$FLOW/build_tree/$PACKAGE_NAME \
            $PACKAGE_PATH

# stop and remove container
docker stop flow_build
docker rm   -f flow_build

# ------------------------------------------------------------------------------

# run container for installation
docker run -tid --name flow_rel flow123d/install
docker exec flow_rel mkdir -p $FLOW

# copy INTO container
docker cp  $PACKAGE_PATH \
            flow_rel:/tmp/$PACKAGE_NAME

# unpack
docker exec flow_rel \
            tar -xvzf /tmp/Flow123d-2.0.0-Linux.tar.gz \
            -C $FLOW --strip-components=1
docker exec flow_rel rm -rf /tmp/Flow123d-2.0.0-Linux.tar.gz


docker export flow_rel > $IMAGE_PATH
docker stop flow_rel
docker rm   -f flow_rel

# # create new image out of container
# docker commit flow_rel flow123d/flow123d-200
# 
# # stop and remove container

# 
# # export image to tar.gz file
# docker save flow123d/flow123d-200 > flow123d-200.tar.gz